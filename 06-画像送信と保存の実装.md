# 06. 画像送信と保存の実装

## データモデルの実装

- データが一意(ユニーク/重複なし)かどうかの判断基準
  - 値クラス : 値全体(ex. 電話番号)
  - エンティティ : 割り当てられるID(ex. ユーザー)

値クラスとエンティティは、ドメイン駆動設計のテクニックの1つ。

## クライアントからの画像の送信
## 画像ファイルのファイルシステムへの保存
## O/Rマッパと DB マイグレーションツールの導入

- O/Rマッパ : ScalaikeJDBC
- マイグレーションツール : Evolutions(PlayFramework のマイグレーションツール)



---

O/Rマッパとは

```
O/Rマッパとは、オブジェクト指向設計によって作られたコードと、データベースのSQLを機械的に対応づけてくれるもの。開発者は、オブジェクト指向設計とSQLの対応を意識せずに開発できる。

アプリケーション開発において、データベースとの連携は標準的である。しかし、オブジェクト指向設計と、データベースとの連携は、両者の設計思想が異なるため、相性が悪い。
オブジェクト指向開発では、クラスや継承といった機能を使って、現実の構造を模倣するように設計していく。一方、SQLは、データを数学的に整理する。もともと設計思想の異なる二つを対応させながら開発すると、処理が煩雑化してしまう。
この食い違いをインピーダンスミスマッチと呼ぶ。O/Rマッパの目的は、インピーダンスミスマッチを解決することにある。O/Rマッピングツールとは、この対応付を自動で行ってくれる。
```

マイグレーションとは

```
マイグレーションツールとは、データベースのバージョンを管理するもの。データベース定義に従ったテーブルの作成や、バージョンアップやダウンを管理してくれる。

定義変更用のSQL文を書かなくてよい
バージョン管理されるため、複数人での開発がし易くなる。
```

DDL,DDM,DCLとは

```
データベースに対する命令の分類

1. データ自体を操作する命令 (DML: Data Manipulation Language) : select,insert,update,delete
2. データを入れておく箱を操作する命令 (DDL:Data Definition Language) : create,alter,drop
3. データベースに関する権限周りを操作する命令 (DCL: Data Control Language) : grant,revoke
```

## 画像ファイルのプロパティへのデータストアへの保存

- 手順
  1. MySQL への保存を担当する PicturePropertyRepository のインタフェースを作る
  2. PicturePropertyRepository の実装の PicturePropertyRepositoryImpl を実装する
  3. DI でバインディングして PicturePropertyRepository のインスタンスを取得できるようにする
  4. 保存時に取得した PictureId を Redis にタスクとして保存できるようにする

---

依存性の注入(DI)とは

```
依存性の注入とは、依存性を外部から注入することで、単体テストをできるようにすること。依存関係にあるオブジェクト同士を切り離して、外部から依存性を注入すること。

動機：
あるオブジェクトが他のオブジェクトに依存していると、単体テストができない。この依存しているものを外部から注入する形に変えてやることで、両者を切り離すことができ、単体テストができるようになる。
```

- そもそもクラス内部でインスタンスを生成しない
- 具体的なクラスに依存しない (trait に依存性を切り離している)

```scala
// そもそもクラス内部でインスタンスを生成しない
object Fortune{
  def main(args: Array[String]) = {
    val input = args.head

    val twitterClient: TwitterClient = new TwitterClientImpl(/*snip*/) //...(1)
    val machine = new FortunePostingMachine(twitterClient)
    machine.run(input)
  }
}

// 具体的なクラスに依存しない (trait に依存性を切り離している)
trait TwitterClient{
  def updateStatus(input: String): Unit
}

class TwitterClientImpl(/* snip */) extends TwitterClient {
  def updateStatus(status: String) = {
    /*snip*/
  }
}
```
